{
  "name": "Al Sabil Travel & Tourism",
  "favicon": "https://storage.googleapis.com/bracketjs.appspot.com/storage-alsabil-tourism/kJsBOQGyl1dbWj52W2iIl-png-1663880307095?GoogleAccessId=firebase-adminsdk-3gkdr%40bracketjs.iam.gserviceaccount.com&Expires=32509461600&Signature=pPtwETCdeYm0HZE3Ie4ge1ILDXwxn8HCx0jtNEqB77j%2FHSV2rcObpDu01%2FyQwkxwtT%2Bm5mPgUWdj7Nri3VTRUMLQYQc9OYhwbSkOLif2q7%2Bw2yTIbWzgXSKIdZ9f3kIxZHX4hrUGUXEX1EMK7TcHgolDg1kHp3WW2LXBIndHNXdyDisv4JTJZwIRUeFgtoKbRNWYfGr4sE0jyMow7o7K86aZMi4aVmw1%2Bwf%2F7rhrIBO61CNCtn9OD%2Fh7N8tC3TsTgHqOw4iE5%2FZMi5FRbzEhhP6hAA8oCbZIHjKJzguRIlyvVb7oge2rYPGY%2BGMI7tnlgtYJUEo40J%2FpAKgpJ7zhGw%3D%3D",
  "which-industry-will-you-be-operating-in": "Travel & Tourism",
  "children": [
    {
      "type": "script?body;src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js'"
    },
    {
      "type": "script?body;src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js'"
    },
    {
      "type": "script?body;src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'"
    },
    {
      "type": "script?body;src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/shim.min.js';integrity='sha512-nPnkC29R0sikt0ieZaAkk28Ib7Y1Dz7IqePgELH30NnSi1DzG4x+envJAOHz8ZSAveLXAHTR3ai2E9DZUsT8pQ==';crossorigin='anonymous';referrerpolicy='no-referrer'"
    }
  ],
  "creation-date": 1651335662000,
  "domains": [
    "alsabil-tourism.bracketjs.com",
    "alsabil-tourism.localhost:8080",
    "www.yalaehjoz.com",
    "yalaehjoz.com"
  ],
  "functions": {
    "InvoiceCancelConnectIssued": "if():[booking-action:()=Cancel Connect Confirmed]:[_.names=_.names.pullItems():[booking-data:().names];InvoiceConfirmedDec();_.confirmed-connected-bookings=[_.confirmed-connected-bookings||0]+1;_.confirmed-connected-seats=[_.confirmed-connected-seats||0]+__.total-seats;_.confirmed-connected-infants=[_.confirmed-connected-infants||0]+__.total-infants;_.confirmed-connected-payable-usd=[_.confirmed-connected-payable-usd||0]+__.total-payable-usd;_.confirmed-connected-commission-usd=[_.confirmed-connected-commission-usd||0]+__.total-commission-usd;_.confirmed-connected-discount-usd=[_.confirmed-connected-discount-usd||0]+[__.total-discount-usd||0];_.confirmed-connected-charge-usd=[_.confirmed-connected-charge-usd||0]+[__.total-charge-usd||0]]",
    "InvoiceConfirmedDec": "_.confirmed-bookings--;_.confirmed-seats-=[__.total-seats];_.confirmed-infants-=[__.total-infants];_.confirmed-payable-usd-=[__.total-payable-usd];_.confirmed-commission-usd-=[__.total-commission-usd];_.confirmed-discount-usd-=[__.total-discount-usd||0];_.confirmed-charge-usd-=[__.total-charge-usd||0]",
    "BookingCancelConfirmed": "booking-action:()=Cancel Confirmed;Booking();Flight();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=booking-data:();success=true;message='Booking canceled successfuly!']",
    "InvoiceDisissueIssued": "if():[booking-action:()=Disissue Confirmed]:[InvoiceUnconfirmedInc()]",
    "InvoiceCancelDisconnectIssued": "if():[booking-action:()=Cancel Disconnect Confirmed]:[_.names=_.names.pullItems():[booking-data:().names];InvoiceConfirmedDec();_.confirmed-disconnected-bookings=[_.confirmed-disconnected-bookings||0]+1;_.confirmed-disconnected-seats=[_.confirmed-disconnected-seats||0]+__.total-seats;_.confirmed-disconnected-infants=[_.confirmed-disconnected-infants||0]+__.total-infants;_.confirmed-disconnected-payable-usd=[_.confirmed-disconnected-payable-usd||0]+__.total-payable-usd;_.confirmed-disconnected-commission-usd=[_.confirmed-disconnected-commission-usd||0]+__.total-commission-usd;_.confirmed-disconnected-discount-usd=[_.confirmed-disconnected-discount-usd||0]+[__.total-discount-usd||0];_.confirmed-disconnected-charge-usd=[_.confirmed-disconnected-charge-usd||0]+[__.total-charge-usd||0]]",
    "InvoiceReissueIssued": "if():[booking-action:()=Reissue Confirmed;!old-booking:().flights.inc():[_.flight-id]]:InvoiceNewIssued()",
    "Counter": "if():[!booking-action:().inc():'Cancel';booking-action:()!=New Unconfirmed;booking-action:()!=Disissue Confirmed;booking-action:()!=Revive Canceled;booking-action:()=New Confirmed||booking-action:()=Issue Unconfirmed||booking-action:().inc():'Confirmed']:[booking-data:().tickets=[booking-data:().tickets||_list];booking-data:().booking-details.0.():[seats.():[passengers-details._():[collections:().counter.e-ticket=counter():[collections:().counter.e-ticket];_.e-ticket=collections:().counter.e-ticket.counter;booking-data:().tickets.replace():[_.e-ticket];if():[_.infants.len()>0]:[_.infants._():[collections:().counter.e-ticket=counter():[collections:().counter.e-ticket];_.e-ticket=collections:().counter.e-ticket.counter;booking-data:().tickets.replace():[_.e-ticket]]]]]]]",
    "InvoiceSplitBooked": "if():[booking-action:()=Split Unconfirmed]:[_.unconfirmed-bookings++;_.unconfirmed-splitted-bookings++;_.unconfirmed-splitted-seats+=__.total-seats;_.unconfirmed-splitted-infants+=__.total-infants;_.unconfirmed-splitted-payable-usd+=__.total-payable-usd;_.unconfirmed-splitted-commission-usd+=__.total-commission-usd;_.unconfirmed-splitted-discount-usd+=[__.total-discount-usd||0];_.unconfirmed-splitted-charge-usd+=[__.total-charge-usd||0]]",
    "BookingNewConfirmed": "booking-action:()=New Confirmed;if():[my-agent:().balance-usd>=booking-data:().total-payable-usd]:[search():[collection=collection;doc=counter]:[collections:().counter=_.data;Booking();Flight();Invoice();Agent();User();save():[collection=collection;data=collections:().counter;doc=counter];save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=booking-data:();success=true;message='Booking created successfuly!']]]:[send():[message=Not enough balance in you account!;success=false]]",
    "InvoiceConnectIssued": "if():[booking-action:()=Connect Confirmed]:[booking-action:()=New Confirmed;InvoiceNewIssued();booking-action:()=Connect Confirmed]",
    "BookingSplitConfirmed": "booking-action:()=Split Confirmed;BookingSplit();Agent();User();Invoice();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight-booking;data=old-booking:()];save():[collection=flight-booking;data=new-booking:()];save():[collection=flight-invoice;data=my-invoices:()];send():[data=_list:[old-booking:()]:[new-booking:()];message='Booking splited successfuly!']",
    "InvoiceCancelBooked": "if():[booking-action:()=Cancel Unconfirmed]:[_.names=_.names.pullItems():[booking-data:().names];InvoiceUnconfirmedDec();_.av-seats=[_.av-seats||0]+[__.total-seats];_.unconfirmed-canceled-bookings=[_.unconfirmed-canceled-bookings||0]+1;_.unconfirmed-canceled-seats=[_.unconfirmed-canceled-seats||0]+__.total-seats;_.unconfirmed-canceled-infants=[_.unconfirmed-canceled-infants||0]+__.total-infants;_.unconfirmed-canceled-payable-usd=[_.unconfirmed-canceled-payable-usd||0]+__.total-payable-usd;_.unconfirmed-canceled-commission-usd=[_.unconfirmed-canceled-commission-usd||0]+__.total-commission-usd;_.unconfirmed-canceled-discount-usd=[_.unconfirmed-canceled-discount-usd||0]+[__.total-discount-usd||0];_.unconfirmed-canceled-charge-usd=[_.unconfirmed-canceled-charge-usd||0]+[__.total-charge-usd||0]]",
    "InvoiceDisconnectBooked": "if():[booking-action:()=Disconnect Unconfirmed]:[booking-action:()=New Unconfirmed;InvoiceNewBooked();booking-action:()=Disconnect Unconfirmed]",
    "createBooking": "my-agent:()=_.agent;booking-data:()=_.booking-data;my-reservations:()=_.reservations;collections:()=_.collections;my-invoices:()=_.invoices;my-flights:()=_.flights;save():[collection=agent;data=my-agent:().clone()]:[my-agent:().del()];save():[collection=flight-booking;data=booking-data:()]:[booking-data:().del()];save():[collection=flight-reservation;data=my-reservations:()]:[my-reservations:()=_list];save():[collection=collection;doc=counter;data=collections:().counter];save():[collection=flight-invoice;data=my-invoices:()]:[my-invoices:()=_list];save():[collection=flight;data=my-flights:()]:[my-flights:()=_list]",
    "BookingReviveCanceled": "booking-action:()=Revive Canceled;old-booking:()=booking-data:().clone();if():[my-flights:().find():[total-av-seats<booking-data:().total-seats]]:[send():[success=false;message='Not enough seats available!']]:[Booking();Flight();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=booking-data:();message='Booking revived successfuly!']]",
    "History": "booking-data:()._():[_.history||=_list;_.history.push():[_map.():[user=creator:().user;user-name=creator:().username;agent=creator:().agent;agent-name=creator:().agent-name;description=if():[booking-action:()=New Unconfirmed]:['New unconfirmed booking has been created!'].elif():[booking-action:()=New Confirmed]:['New confirmed booking has been created!'].elif():[booking-action:()=Disissue Confirmed]:['New unconfirmed booking has been created from a disissue!'].elif():[booking-action:()=Cancel Disissued]:['Confirmed booking has been disissued!'].elif():[booking-action:()=Issue Unconfirmed]:['Unconfirmed booking has been issued!'].elif():[booking-action:()=Revive Canceled]:['Canceled booking has been revived!'].elif():[booking-action:()=Rebook Unconfirmed]:['Unconfirmed booking has been created from rebook!'].elif():[booking-action:()=Reissue Confirmed]:['Confirmed booking has been created from reissue!'].elif():[booking-action:()=Cancel Rebooked]:['Unconfirmed booking has been rebooked!'].elif():[booking-action:()=Cancel Reissued]:['Confirmed booking has been reissued!'].elif():[booking-action:()=Cancel Unconfirmed]:['Unconfirmed booking has been canceled!'].elif():[booking-action:()=Cancel Confirmed]:['Confirmed booking has been canceled!'].elif():[booking-action:()=Cancel Rebooked]:['Booking has been rebooked!'].elif():[booking-action:()=Cancel Reissued]:['Booking has been reissued!'].elif():[booking-action:()=Cancel Connect Unconfirmed]:['Unconfirmed booking has been connected. New pnr is '+new-booking:().pnr].elif():[booking-action:()=Cancel Connect Confirmed]:['Confirmed booking has been connected. New pnr is '+new-booking:().pnr].elif():[booking-action:()=Cancel Disconnect Unconfirmed]:['Unconfirmed booking has been disconnected. New pnrs are '+new-bookings:().():pnr.join():'and '].elif():[booking-action:()=Cancel Disconnect Confirmed]:['Confirmed booking has been disconnected. New pnrs are '+new-bookings:().():pnr.join():'and '].elif():[booking-action:()=Connect Unconfirmed]:['Confirmed bookings have been connected. Old pnrs are '+old-bookings:().():pnr.join():'and '].elif():[booking-action:()=Connect Confirmed]:['Confirmed bookings have been connected. Old pnrs are '+old-bookings:().():pnr.join():'and '].elif():[booking-action:()=Disconnect Unconfirmed]:['Unconfirmed booking have been disconnected. Old pnr is '+old-booking:().pnr].elif():[booking-action:()=Split Confirmed]:[counters:()+' pax splited to a new confirmed booking pnr '+new-booking:().pnr].elif():[booking-action:()=Split Unconfirmed]:[counters:()+' pax splited to a new unconfirmed booking pnr '+new-booking:().pnr].elif():[booking-action:()=New Split Confirmed]:['A new confirmed booking created from booking pnr '+old-booking:().pnr].elif():[booking-action:()=New Split Unconfirmed]:['A new unconfirmed booking created from booking pnr '+old-booking:().pnr].elif():[booking-action:()=Edit Unconfirmed]:'Unconfirmed booking has been edited'.elif():[booking-action:()=Edit Confirmed]:'Confirmed booking has been edited';status=Confirmed;date=today().timestamp();if():[booking-action:().inc():Edit]:[().edits=_list;().old-passengers=old-booking:().booking-details.0.seats.():[passengers-details].flat();().new-passengers=booking-data:().booking-details.0.seats.():[passengers-details].flat();().old-passengers._():[().new-passengers.find():[counter=_.counter]._():[if():[_!=__]:[_.keys()._():[if():[__._!=___._]:[().edits.push():[_map.():[counter=__.counter;field=_;before-value=___._;after-value=__._]]]]]]];edits=().edits]]]]",
    "InvoiceIssueBooked": "if():[booking-action:()=Issue Unconfirmed]:[InvoiceUnconfirmedDec();InvoiceConfirmedInc();_.unconfirmed-issued-bookings=[_.unconfirmed-issued-bookings||0]+1;_.unconfirmed-issued-seats=[_.unconfirmed-issued-seats||0]+__.total-seats;_.unconfirmed-issued-infants=[_.unconfirmed-issued-infants||0]+__.total-infants;_.unconfirmed-issued-payable-usd=[_.unconfirmed-issued-payable-usd||0]+__.total-payable-usd;_.unconfirmed-issued-commission-usd=[_.unconfirmed-issued-commission-usd||0]+__.total-commission-usd;_.unconfirmed-issued-discount-usd=[_.unconfirmed-issued-discount-usd||0]+[__.total-discount-usd||0];_.unconfirmed-issued-charge-usd=[_.unconfirmed-issued-charge-usd||0]+[__.total-charge-usd||0]]",
    "BookingReissueConfirmed": "booking-action:()=Reissue Confirmed;new-booking:()=booking-data:().clone();new-flights:()=my-flights:().clone();new-invoices:()=my-invoices:().clone();booking-data:()=old-booking:().clone();if():[my-agent:().balance-usd+old-booking:().total-payable-usd>=new-booking:().total-payable-usd]:[booking-action:()=Cancel Reissued;search():[collection=flight;docs=booking-data:().flights]:[my-flights:()=_.data;search():[collection=flight-invoice;field.flight-id.in=booking-data:().flights]:[my-invoices:()=_.data.values();Booking();Flight();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];booking-action:()=Reissue Confirmed;my-flights:()=new-flights:().clone();my-invoices:()=new-invoices:().clone();old-booking:()=booking-data:().clone();booking-data:()=new-booking:().clone();search():[collection=collection;doc=counter]:[collections:().counter=_.data;Booking();Flight();Invoice();Agent();User();save():[collection=collection;data=collections:().counter;doc=counter];save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[message='Booking reissued successfuly!';data=_list:[old-booking:()]:[booking-data:()]]]]]]:[send():[message='Unenough balance in your account!';success=false]]",
    "InvoiceCancelConnectBooked": "if():[booking-action:()=Cancel Connect Unconfirmed]:[_.names=_.names.pullItems():[booking-data:().names];InvoiceUnconfirmedDec();_.unconfirmed-connected-bookings=[_.unconfirmed-connected-bookings||0]+1;_.unconfirmed-connected-seats=[_.unconfirmed-connected-seats||0]+__.total-seats;_.unconfirmed-connected-infants=[_.unconfirmed-connected-infants||0]+__.total-infants;_.unconfirmed-connected-payable-usd=[_.unconfirmed-connected-payable-usd||0]+__.total-payable-usd;_.unconfirmed-connected-commission-usd=[_.unconfirmed-connected-commission-usd||0]+__.total-commission-usd;_.unconfirmed-connected-discount-usd=[_.unconfirmed-connected-discount-usd||0]+[__.total-discount-usd||0];_.unconfirmed-connected-charge-usd=[_.unconfirmed-connected-charge-usd||0]+[__.total-charge-usd||0]]",
    "InvoiceUnconfirmedDec": "_.unconfirmed-bookings--;log():[_.unconfirmed-seats];_.unconfirmed-seats-=__.total-seats;log():[_.unconfirmed-seats];_.unconfirmed-infants-=__.total-infants;_.unconfirmed-payable-usd-=__.total-payable-usd;_.unconfirmed-commission-usd-=__.total-commission-usd;_.unconfirmed-discount-usd-=[__.total-discount-usd||0];_.unconfirmed-charge-usd-=[__.total-charge-usd||0]",
    "Book": "creator:()=_.creator;booking-action:()=_.action;booking-data:()=_.booking;old-booking:()=_.old-booking;counters:()=_.counters;if():[booking-action:().inc():Edit]:[booking-data:()._():[updateNames()];History();save():[collection=flight-booking;data=booking-data:()];send():[data=booking-data:();success=true;message='Booking edited successfuly!']]:[new-booking:()=_.new-booking;old-bookings:()=_.old-bookings;new-bookings:()=_.new-bookings;my-flights:()=_.booking.flights;().mounted=agentuserflightinvoice;search():[collection=agent;doc=_.agent]:[my-agent:()=_.data;().mounted=().mounted.replace():agent;book()];search():[collection=user;doc=_.user]:[user:()=_.data;().mounted=().mounted.replace():user;book()];search():[collection=flight;docs=booking-data:().flights]:[my-flights:()=_.data.values();().mounted=().mounted.replace():flight;book()];search():[collection=flight-invoice;field.flight-id.in=booking-data:().flights]:[my-invoices:()=_.data.values();().mounted=().mounted.replace():invoice;book()]];#DetectNameRepition():[names=booking-data:().clone().booking-details.0.():[seats.():[passengers-details.():[first-name+ +last-name]].flat()].flat().filter();flights=booking-data:().flights]",
    "getCollections": "search():[collection=collection]:[send():[search:().data]]",
    "save-user-and-agent": "save():[collection=user;data=user:()];save():[collection=agent;data=agent:()]",
    "loginUser": "search():[collection=user;field.username.equal=_.user;field.password.equal=_.pass]:[if():[_.data.value()]:[user:()=_.data.value();search():[collection=agent;doc=user:().agent]:[if():[_.data]:[agent:()=_.data;update-user-and-agent();send():[data=_map.():[user=user:().clone().del():password;agent=agent:()];message=Welcome +user:().first-name+ +user:().last-name+'!']]:[send():[data=false;message=Agent does not exist!]]]]:[send():[data=false;message=Username entered is incorrect!]]]",
    "InvoiceConnectBooked": "if():[booking-action:()=Connect Unconfirmed]:[booking-action:()=New Unconfirmed;InvoiceNewBooked();booking-action:()=Connect Unconfirmed]",
    "BookingConnectConfirmed": "booking-action:()=Connect Confirmed;search():[collection=agent;doc=my-agent:().id]:[my-agent:()=search:().data;if():[my-agent:().balance-usd+old-bookings:().():total-payable-usd.sum()>=new-booking:().total-payable-usd]:[search():[collection=flight;docs=old-bookings:().():flights.flat()]:[my-flights:()=search:().data.values();search():[collection=collection;doc=counter]:[collections:().counter=search:().data;Booking();Flight();search():[collection=flight-invoice;field.flight-id.in=booking-data:().flights]:[my-invoices:()=search:().data.values();Invoice();Agent();User();save():[collection=collection;data=collections:().counter;doc=counter];save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];bookings:().replaceItem():[booking-data:().clone()]]]];booking-action:()=Cancel Connect Confirmed;search():[collection=flight;docs=old-bookings:().():flights.flat()]:[my-flights:()=search:().data.values().filter():[id.in];search():[collection=flight-invoice;field.flight-id.in=booking-data:().flights]:[my-Invoices:()=search:().data.values();Booking();Flight();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];bookings:().replaceItem():[booking-data:().clone()]]]]]",
    "Booking": "().current-balance=my-agent:().balance-usd;booking-data:()._():[if():[booking-action:()=Revive Canceled||booking-action:()=New Unconfirmed||booking-action:()=New Confirmed||booking-action:()=Reissue Confirmed||booking-action:()=Rebook Unconfirmed||booking-action:()=Join Confirmed||booking-action:()=Join Unconfirmed||booking-action:()=Connect Confirmed||booking-action:()=Connect Unconfirmed||booking-action:()=Disconnect Confirmed||booking-action:()=Disconnect Unconfirmed||booking-action:()=Issue Unconfirmed||booking-action:()=Disissue Confirmed]:[if():[booking-action:()=New Unconfirmed||booking-action:()=Disissue Confirmed||booking-action:()=New Confirmed||booking-action:()=Reissue Confirmed||booking-action:()=Rebook Unconfirmed||booking-action:()=Revive Canceled]:[_.creation-date=today().timestamp();_.creation-day=todayStart().timestamp();_.created-by=user:().id;_.created-by-name=user:().username;_.created-by-agent=my-agent:().id;_.created-by-agent-name=my-agent:().company-name];if():[booking-action:()=Revive Canceled||booking-action:()=Disissue Confirmed||booking-action:()=Reissue Confirmed]:[_.history=_list;_.id=gen():20;_.split-date.del();_.spliting-day.del();_.splited-by.del();_.splited-by-name.del();_.splited-by-agent.del();_.splited-by-agent-name.del();_.cancelation-date.del();_.cancelation-day.del();_.canceled-by.del();_.canceled-by-name.del();_.canceled-by-agent.del();_.canceled-by-agent-name.del();_.cancel-start-balance-usd.del();_.cancel-end-balance-usd.del();_.total-canceled-base-fare-usd.del();_.total-canceled-commission-usd.del();_.total-canceled-fees-usd.del();_.total-canceled-passengers.del();_.total-canceled-payable-usd.del();_.total-canceled-seats.del();_.total-canceled-taxes.del();_.total-canceled-discount.del();_.total-canceled-charge.del()];if():[booking-action:()=New Unconfirmed||booking-action:()=Disissue Confirmed||booking-action:()=Revive Canceled]:[_.status=Booked;_.booking-date=today().timestamp();_.booking-day=todayStart().timestamp();_.booked-by=user:().id;_.booked-by-name=user:().username;_.booked-by-agent=my-agent:().id;_.booked-by-agent-name=my-agent:().company-name]:[if():[_.status!=Booked]:[_.booking-date=today().timestamp();_.booking-day=todayStart().timestamp();_.booked-by=user:().id;_.booked-by-name=user:().username;_.booked-by-agent=my-agent:().id;_.booked-by-agent-name=my-agent:().company-name];_.status=Issued;_.issuing-date=today().timestamp();_.issuing-day=todayStart().timestamp();_.issued-by=user:().id;_.issued-by-name=user:().username;_.issued-by-agent=my-agent:().id;_.issued-by-agent-name=my-agent:().company-name];if():[booking-action:()!=Issue Unconfirmed;booking-action:()!=Disissue Confirmed;booking-action:()!=Revive Canceled]:[_.agent=my-agent:().id;_.agent-name=my-agent:().company-name;_.user=user:().id;_.user-name=user:().username;if():[booking-action:()=Reissue Confirmed]:[_.history=_list;_.pnr=old-booking:().pnr]:[_.pnr=gen():6.uppercase()];_.id=gen():20;_.active=true;_.flights=my-flights:().():id.clone();().flight1=my-flights:().find():[id=_.booking-details.0.flight-id];[_.travel-date=().flight1.departure-day;_.go-departure-airport=().flight1.departure-airport;_.go-departure-time=().flight1.departure-time;_.go-arrival-airport=().flight1.arrival-airport;_.go-arrival-time=().flight1.arrival-time;if():[my-flights:().len()=2]:[().flight2=my-flights:().find():[id=_.booking-details.1.flight-id];_.return-date=().flight2.departure-day;_.return-departure-airport=().flight2.departure-airport;_.return-departure-time=().flight2.departure-time;_.return-arrival-airport=().flight2.arrival-airport;_.return-arrival-time=().flight2.arrival-time]]];if():[booking-action:()!=Disissue Confirmed;booking-action:()!=Revive Canceled;booking-action:()=New Confirmed||booking-action:()=Issue Unconfirmed||booking-action:().inc():Confirmed]:[_.start-balance-usd=().current-balance;_.end-balance-usd=().current-balance-[_.total-payable-usd]]:[_.start-balance-usd.del();_.end-balance-usd.del();_.canceled-start-balance-usd.del();_.canceled-end-balance-usd.del();_.tickets.del()];_.booking-details.():[seats.():[passengers-details._():[if():[booking-action:()=New Unconfirmed||booking-action:()=Disissue Confirmed||booking-action:().inc():Unconfirmed||booking-action:()=Revive Canceled]:[_.status=Booked]:[_.status=Issued];if():[booking-action:()!=Disissue Confirmed;booking-action:()!=Revive Canceled;booking-action:()=New Confirmed||booking-action:()=Issue Unconfirmed||booking-action:().inc():'Confirmed']:[_.start-balance-usd=().current-balance;_.end-balance-usd=().current-balance-[_.payable-usd]]:[_.start-balance-usd.del();_.end-balance-usd.del();_.e-ticket.del();_.canceled-start-balance-usd.del();_.canceled-end-balance-usd.del()];if():[_.infants.len()>0]:[_.infants._():[if():[booking-action:()=New Unconfirmed||booking-action:()=Disissue Confirmed||booking-action:()=Revive Canceled||booking-action:().inc():'Unconfirmed']:[_.status=Booked]:[_.status=Issued];if():[booking-action:()!=Disissue Confirmed;booking-action:()!=Revive Canceled;booking-action:()=New Confirmed||booking-action:()=Issue Unconfirmed||booking-action:().inc():Confirmed]:[_.start-balance-usd=().current-balance;().current-balance-=_.payable-usd;_.end-balance-usd=().current-balance]:[_.start-balance-usd.del();_.end-balance-usd.del();_.e-ticket.del();_.canceled-start-balance-usd.del();_.canceled-end-balance-usd.del()]]]]]]].elif():[booking-action:().inc():Cancel]:[_.status=Canceled;_.cancelation-date=today().timestamp();_.cancelation-day=todayStart().timestamp();_.canceled-by=user:().id;_.canceled-by-name=user:().username;_.canceled-by-agent=my-agent:().id;_.canceled-by-agent-name=my-agent:().company-name;if():[booking-action:().inc():Confirmed||booking-action:()=Cancel Reissued||booking-action:()=Cancel Disissued]:[_.cancel-start-balance-usd=().current-balance;_.cancel-end-balance-usd=().current-balance+_.total-payable-usd];_.booking-details.():[seats.():[passengers-details._():[_.status=Canceled;if():[booking-action:().inc():'Confirmed'||booking-action:()=Cancel Reissued||booking-action:()=Cancel Disissued]:[_.cancel-start-balance-usd=().current-balance;().current-balance+=_.payable-usd;_.cancel-end-balance-usd=().current-balance];if():[_.infants.len()>0]:[_.infants._():[_.status=Canceled;if():[booking-action:().inc():'Confirmed'||booking-action:()=Cancel Reissued||booking-action:()=Cancel Disissued]:[_.cancel-start-balance-usd=().current-balance;().current-balance+=_.payable-usd;_.cancel-end-balance-usd=().current-balance]]]]]]];updateNames();if():[booking-action:()=Reissue Confirmed||booking-action:()=Rebook Unconfirmed]:[InheritPassengerDetails()]];Counter();History()",
    "Agent": "if():[my-agent:().today!=todayStart().timestamp()]:[my-agent:().today=todayStart().timestamp();my-agent:().today-confirmed-buyings-usd=0;my-agent:().today-confirmed-bookings=0;my-agent:().today-unconfirmed-buyings-usd=0;my-agent:().today-unconfirmed-bookings=0];booking-data:()._():[if():[booking-action:()=Cancel Connect Confirmed||booking-action:()=Cancel Disconnect Confirmed||booking-action:()=Cancel Confirmed||booking-action:()=Cancel Reissued||booking-action:()=Cancel Disissued]:[my-agent:().balance-usd+=_.total-payable-usd;my-agent:().confirmed-buyings-usd-=[_.total-payable-usd];my-agent:().confirmed-bookings--;my-agent:().today-confirmed-buyings-usd-=[_.total-payable-usd];my-agent:().today-confirmed-bookings--].elif():[booking-action:()=Cancel Connect Unconfirmed||booking-action:()=Cancel Disconnect Unconfirmed||booking-action:()=Cancel Unconfirmed||booking-action:()=Cancel Rebooked]:[my-agent:().unconfirmed-buyings-usd=[my-agent:().unconfirmed-buyings-usd||0]-[_.total-payable-usd];my-agent:().unconfirmed-bookings=[my-agent:().unconfirmed-bookings||0]-1;my-agent:().today-unconfirmed-buyings-usd=[my-agent:().today-unconfirmed-buyings-usd||0]-[_.total-payable-usd];my-agent:().today-unconfirmed-bookings=[my-agent:().today-unconfirmed-bookings||0]-1].elif():[booking-action:()=Connect Confirmed||booking-action:()=Disconnect Confirmed||booking-action:()=Issue Unconfirmed||booking-action:()=New Confirmed||booking-action:()=Reissue Confirmed]:[my-agent:().balance-usd-=_.total-payable-usd;my-agent:().confirmed-buyings-usd=[my-agent:().confirmed-buyings-usd||0]+[_.total-payable-usd];my-agent:().confirmed-bookings=[my-agent:().confirmed-bookings||0]+1;my-agent:().today-confirmed-buyings-usd=[my-agent:().today-confirmed-buyings-usd||0]+[_.total-payable-usd];my-agent:().today-confirmed-bookings=[my-agent:().today-confirmed-bookings||0]+1].elif():[booking-action:()=Connect Unconfirmed||booking-action:()=Disconnect Unconfirmed||booking-action:()=New Unconfirmed||booking-action:()=Rebook Unconfirmed||booking-action:()=Revive Canceled||booking-action:()=Disissue Confirmed]:[my-agent:().unconfirmed-buyings-usd=[my-agent:().unconfirmed-buyings-usd||0]+[_.total-payable-usd];my-agent:().unconfirmed-bookings=[my-agent:().unconfirmed-bookings||0]+1;my-agent:().today-unconfirmed-buyings-usd=[my-agent:().today-unconfirmed-buyings-usd||0]+[_.total-payable-usd];my-agent:().today-unconfirmed-bookings=[my-agent:().today-unconfirmed-bookings||0]+1].elif():[booking-action:()=Split Confirmed]:[my-agent:().confirmed-bookings=[my-agent:().confirmed-bookings||0]+1;my-agent:().today-confirmed-bookings=[my-agent:().today-confirmed-bookings||0]+1].elif():[booking-action:()=Split Unconfirmed]:[my-agent:().unconfirmed-bookings=[my-agent:().unconfirmed-bookings||0]+1;my-agent:().today-unconfirmed-bookings=[my-agent:().today-unconfirmed-bookings||0]+1]]",
    "BookingSplitUnconfirmed": "booking-action:()=Split Unconfirmed;BookingSplit();Agent();User();Invoice();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight-booking;data=old-booking:()];save():[collection=flight-booking;data=new-booking:()];save():[collection=flight-invoice;data=my-invoices:()];send():[data=_list:[old-booking:()]:[new-booking:()];message='Booking splited successfuly!']",
    "BookingIssueUnconfirmed": "booking-action:()=Issue Unconfirmed;if():[my-agent:().balance-usd>=booking-data:().total-payable-usd]:[search():[collection=collection;doc=counter]:[collections:().counter=search:().data;Booking();Invoice();Agent();User();save():[collection=collection;data=collections:().counter;doc=counter];save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=booking-data:();success=true;message='Booking confirmed successfuly!']]]:[send():[message=Not enough balance in you account!;success=false]]",
    "InvoiceCancelRebooked": "if():[booking-action:()=Cancel Rebooked]:[if():[!new-booking:().flights.inc():[_.flight-id]]:InvoiceUnconfirmedDec();_.unconfirmed-rebooked-bookings=[_.unconfirmed-rebooked-bookings||0]+1;_.unconfirmed-rebooked-seats=[_.unconfirmed-rebooked-seats||0]+__.total-seats;_.unconfirmed-rebooked-infants=[_.unconfirmed-rebooked-infants||0]+__.total-infants;_.unconfirmed-rebooked-payable-usd=[_.unconfirmed-rebooked-payable-usd||0]+__.total-payable-usd;_.unconfirmed-rebooked-commission-usd=[_.unconfirmed-rebooked-commission-usd||0]+__.total-commission-usd;_.unconfirmed-rebooked-discount-usd=[_.unconfirmed-rebooked-discount-usd||0]+[__.total-discount-usd||0];_.unconfirmed-rebooked-charge-usd=[_.unconfirmed-rebooked-charge-usd||0]+[__.total-charge-usd||0]]",
    "InheritPassengerDetails": "().passengers-details=_list;old-booking:().():[booking-details.():[seats.():[passengers-details._():[().passengers-details.push():[_map.():[counter=_.counter;first-name=[_.first-name||_string];last-name=[_.last-name||_string];age=[_.age||_string];gender=[_.gender||_string];title=[_.title||_string];dob=[_.dob||_string];nationality=[_.nationality||_string];passport-number=[_.passport-number||_string];passport-issuer=[_.passport-issuer||_string];passport-expiry-date=[_.passport-expiry-date||_string];contact-number=[_.contact-number||_string];email=[_.email||_string];infants=_.infants._():[_map.():[counter=_.counter;first-name=[_.first-name||_string];last-name=[_.last-name||_string];age=[_.age||_string];gender=[_.gender||_string];title=[_.title||_string];dob=[_.dob||_string];nationality=[_.nationality||_string];passport-number=[_.passport-number||_string];passport-issuer=[_.passport-issuer||_string];passport-expiry-date=[_.passport-expiry-date||_string]]]]]]]]]];booking-data:().():[booking-details.():[seats.():[passengers-details._():[_=().passengers-details.find():[counter=_.counter]]]]]",
    "InvoiceReviveCanceled": "if():[booking-action:()=Revive Canceled]:[InvoiceUnconfirmedInc();_.unconfirmed-revived-bookings++;_.unconfirmed-revived-seats+=__.total-seats;_.unconfirmed-revived-infants+=__.total-infants;_.unconfirmed-revived-payable-usd+=__.total-payable-usd;_.unconfirmed-revived-commission-usd+=__.total-commission-usd;_.unconfirmed-revived-discount-usd+=[__.total-discount-usd||0];_.unconfirmed-revived-charge-usd+=[__.total-charge-usd||0]]",
    "checkUser": "if():[_.agent;_.user]:[().mount='agentuser';search():[collection=agent;doc=_.agent]:[agent:()=search:().data;().mount.replace():agent;routeLogin()];search():[collection=user;doc=_.user]:[user:()=search:().data;().mount.replace():user:;routeLogin()]]",
    "InvoiceNewIssued": "if():[booking-action:()=New Confirmed]:[InvoiceConfirmedInc();_.av-seats=[_.av-seats||0]-[__.total-seats];_.confirmed-issued-bookings=[_.confirmed-issued-bookings||0]+1;_.confirmed-issued-seats=[_.confirmed-issued-seats||0]+__.total-seats;_.confirmed-issued-infants=[_.confirmed-issued-infants||0]+[__.total-infants||0];_.confirmed-issued-payable-usd=[_.confirmed-issued-payable-usd||0]+__.total-payable-usd;_.confirmed-issued-commission-usd=[_.confirmed-issued-commission-usd||0]+__.total-commission-usd;_.confirmed-issued-discount-usd=[_.confirmed-issued-discount-usd||0]+[__.total-discount-usd||0];_.confirmed-issued-charge-usd=[_.confirmed-issued-charge-usd||0]+[__.total-charge-usd||0]]",
    "update-uses-and-last-visit": "agent:().[today-uses]=agent:().[today-uses]+1;agent:().uses=agent:().uses+1;agent:().last-visit=today().timestamp();user:().uses=user:().uses+1;user:().[today-uses]=user:().[today-uses]+1;user:().last-visit=today().timestamp()",
    "InvoiceCancelDisissued": "if():[booking-action:()=Cancel Disissued]:[_.names=_.names.pullItems():[booking-data:().names];InvoiceConfirmedDec();_.confirmed-disissued-bookings++;_.confirmed-disissued-seats+=__.total-seats;_.confirmed-disissued-infants+=__.total-infants;_.confirmed-disissued-payable-usd+=__.total-payable-usd;_.confirmed-disissued-commission-usd+=__.total-commission-usd;_.confirmed-disissued-discount-usd+=[__.total-discount-usd||0];_.confirmed-disissued-charge-usd+=[__.total-charge-usd||0]]pullItems():[booking-data:().names];InvoiceConfirmedDec();_.confirmed-disissued-bookings++;_.confirmed-disissued-seats+=__.total-seats;_.confirmed-disissued-infants+=__.total-infants;_.confirmed-disissued-payable-usd+=__.total-payable-usd;_.confirmed-disissued-commission-usd+=__.total-commission-usd;_.confirmed-disissued-discount-usd+=[__.total-discount-usd||0];_.confirmed-disissued-charge-usd+=[__.total-charge-usd||0]]",
    "InvoiceCancelIssued": "if():[booking-action:()=Cancel Confirmed]:[_.names=_.names.pullItems():[booking-data:().names];InvoiceConfirmedDec();_.av-seats+=[__.total-seats];_.confirmed-canceled-bookings=[_.confirmed-canceled-bookings||0]+1;_.confirmed-canceled-seats=[_.confirmed-canceled-seats||0]+__.total-seats;_.confirmed-canceled-infants=[_.confirmed-canceled-infants||0]+__.total-infants;_.confirmed-canceled-payable-usd=[_.confirmed-canceled-payable-usd||0]+__.total-payable-usd;_.confirmed-canceled-commission-usd=[_.confirmed-canceled-commission-usd||0]+__.total-commission-usd;_.confirmed-canceled-discount-usd=[_.confirmed-canceled-discount-usd||0]+[__.total-discount-usd||0];_.confirmed-canceled-charge-usd=[_.confirmed-canceled-charge-usd||0]+[__.total-charge-usd||0]]pullItems():[booking-data:().names];InvoiceConfirmedDec();_.av-seats+=[__.total-seats];_.confirmed-canceled-bookings=[_.confirmed-canceled-bookings||0]+1;_.confirmed-canceled-seats=[_.confirmed-canceled-seats||0]+__.total-seats;_.confirmed-canceled-infants=[_.confirmed-canceled-infants||0]+__.total-infants;_.confirmed-canceled-payable-usd=[_.confirmed-canceled-payable-usd||0]+__.total-payable-usd;_.confirmed-canceled-commission-usd=[_.confirmed-canceled-commission-usd||0]+__.total-commission-usd;_.confirmed-canceled-discount-usd=[_.confirmed-canceled-discount-usd||0]+[__.total-discount-usd||0];_.confirmed-canceled-charge-usd=[_.confirmed-canceled-charge-usd||0]+[__.total-charge-usd||0]]",
    "BookingCancelUnconfirmed": "booking-action:()=Cancel Unconfirmed;Booking();Flight();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=booking-data:();success=true;message='Booking canceled successfuly!']",
    "Invoice": "booking-data:().booking-details._():[my-invoices:().find():[flight-id=_.flight-id]._():[InvoiceCancelBooked();InvoiceCancelIssued();InvoiceCancelDisissued();InvoiceCancelConnectBooked();InvoiceCancelConnectIssued();InvoiceCancelDisconnectBooked();InvoiceCancelDisconnectIssued();InvoiceCancelRebooked();InvoiceCancelReissued();InvoiceConnectBooked();InvoiceConnectIssued();InvoiceDisconnectBooked();InvoiceDisconnectIssued();InvoiceDisissueIssued();InvoiceIssueBooked();InvoiceNewBooked();InvoiceNewIssued();InvoiceRebookBooked();InvoiceReissueIssued();InvoiceReviveCanceled();InvoiceSplitBooked();InvoiceSplitIssued()]]",
    "InvoiceDisconnectIssued": "if():[booking-action:()=Disconnect Confirmed]:[booking-action:()=New Confirmed;InvoiceNewIssued();booking-action:()=Disconnect Confirmed]",
    "InvoiceSplitIssued": "if():[booking-action:()=Split Confirmed]:[_.confirmed-bookings++;_.confirmed-splitted-bookings++;_.confirmed-splitted-seats+=__.total-seats;_.confirmed-splitted-infants+=__.total-infants;_.confirmed-splitted-payable-usd+=__.total-payable-usd;_.confirmed-splitted-commission-usd+=__.total-commission-usd;_.confirmed-splitted-discount-usd+=[__.total-discount-usd||0];_.confirmed-splitted-charge-usd+=[__.total-charge-usd||0]]",
    "InvoiceCancelReissued": "if():[booking-action:()=Cancel Reissued]:[if():[!new-booking:().flights.inc():[_.flight-id]]:InvoiceConfirmedDec();_.confirmed-reissued-bookings++;_.confirmed-reissued-seats+=__.total-seats;_.confirmed-reissued-infants+=__.total-infants;_.confirmed-reissued-payable-usd+=__.total-payable-usd;_.confirmed-reissued-commission-usd+=__.total-commission-usd;_.confirmed-reissued-discount-usd+=[__.total-discount-usd||0];_.confirmed-reissued-charge-usd+=[__.total-charge-usd||0]]",
    "User": "if():[user:().today!=todayStart().timestamp()]:[user:().today=todayStart().timestamp();user:().today-confirmed-buyings-usd=0;user:().today-confirmed-bookings=0;user:().today-unconfirmed-buyings-usd=0;user:().today-unconfirmed-bookings=0];booking-data:()._():[if():[booking-action:()=Cancel Connect Confirmed||booking-action:()=Cancel Disconnect Confirmed||booking-action:()=Cancel Confirmed||booking-action:()=Cancel Reissued||booking-action:()=Cancel Disissued]:[user:().confirmed-buyings-usd-=[_.total-payable-usd];user:().confirmed-bookings--;user:().today-confirmed-buyings-usd-=[_.total-payable-usd];user:().today-confirmed-bookings--].elif():[booking-action:()=Cancel Connect Unconfirmed||booking-action:()=Cancel Disconnect Unconfirmed||booking-action:()=Cancel Unconfirmed||booking-action:()=Cancel Rebooked]:[user:().unconfirmed-buyings-usd=[user:().unconfirmed-buyings-usd||0]-[_.total-payable-usd];user:().unconfirmed-bookings=[user:().unconfirmed-bookings||0]-1;user:().today-unconfirmed-buyings-usd=[user:().today-unconfirmed-buyings-usd||0]-[_.total-payable-usd];user:().today-unconfirmed-bookings=[user:().today-unconfirmed-bookings||0]-1].elif():[booking-action:()=Connect Confirmed||booking-action:()=Disconnect Confirmed||booking-action:()=Issue Unconfirmed||booking-action:()=New Confirmed||booking-action:()=Revive Confirmed||booking-action:()=Split Confirmed]:[user:().confirmed-buyings-usd=[user:().confirmed-buyings-usd||0]+[_.total-payable-usd];user:().confirmed-bookings=[user:().confirmed-bookings||0]+1;user:().today-confirmed-buyings-usd=[user:().today-confirmed-buyings-usd||0]+[_.total-payable-usd];user:().today-confirmed-bookings=[user:().today-confirmed-bookings||0]+1].elif():[booking-action:()=Connect Unconfirmed||booking-action:()=Disconnect Unconfirmed||booking-action:()=Disissue Confirmed||booking-action:()=New Unconfirmed||booking-action:()=Rebook Unconfirmed||booking-action:()=Revive Canceled||booking-action:()=Split Unconfirmed||booking-action:()=Disissue Confirmed]:[user:().unconfirmed-buyings-usd+=[_.total-payable-usd];user:().unconfirmed-bookings++;user:().today-unconfirmed-buyings-usd+=[_.total-payable-usd];user:().today-unconfirmed-bookings++].elif():[booking-action:()=Split Confirmed]:[user:().confirmed-bookings=[user:().confirmed-bookings||0]+1;user:().today-confirmed-bookings=[user:().today-confirmed-bookings||0]+1].elif():[booking-action:()=Split Unconfirmed]:[user:().unconfirmed-bookings=[user:().unconfirmed-bookings||0]+1;user:().today-unconfirmed-bookings=[user:().today-unconfirmed-bookings||0]+1]]",
    "Flight": "if():[booking-action:().inc():'Cancel';booking-action:()!=Revive Canceled]:[my-flights:().filter():[!id.in():[[new-booking:()||_list].booking-details.():[flight-id]||_list]]._():[_.total-av-seats+=booking-data:().total-seats];booking-data:().booking-details._():[my-flights:().filter():[!id.in():[[new-booking:()||_list].booking-details.():[flight-id]||_list]].find():[id=_.flight-id].seats.filter():[sub-class.in():[_.seats.():class]]._():[_.av-seats=[_.av-seats||0]+__.seats.find():[class=_.sub-class].total-seats]]].elif():[booking-action:()=Revive Canceled||booking-action:()=New Confirmed||booking-action:()=Reissue Confirmed||booking-action:()=New Unconfirmed||booking-action:()=Rebook Unconfirmed||booking-action:()=Reissue Confirmed]:[my-flights:().filter():[!id.in():[[old-booking:()||_list].booking-details.():[flight-id]||_list]]._():[_.total-av-seats=[_.total-av-seats||0]-[booking-data:().total-seats]];booking-data:().booking-details._():[my-flights:().filter():[!id.in():[[old-booking:()||_list].booking-details.():[flight-id]||_list]].find():[id=_.flight-id].seats.filter():[sub-class.in():[_.seats.():class]]._():[_.av-seats=[_.av-seats||0]-[__.seats.find():[class=_.sub-class].total-seats]]]]",
    "reset-user-and-agent": "if():[agent:().today!=todayStart().timestamp()]:[agent:().():[today=todayStart().timestamp();[today-uses]=0;today-bookings=0;today-buyings-usd=0]];if():[user:().today!=todayStart().timestamp()]:[user:().():[today=todayStart().timestamp();[today-uses]=0;today-bookings=0;today-buyings-usd=0]]",
    "update-user-and-agent": "reset-user-and-agent();update-uses-and-last-visit();save-user-and-agent()",
    "BookingSplit": "new-booking:()=booking-data:().clone();old-booking:()=booking-data:().clone();old-booking:().booking-details.():[seats.():[passengers-details.pullItems():[counter.in():[counters:()]]].pullItems():[passengers-details.len()=0]];new-booking:().booking-details.():[seats.():[passengers-details.pullItems():[!counter.in():[counters:()]]].pullItems():[passengers-details.len()=0]];().current-balance=old-booking:().start-balance-usd;new-booking:()._():[_.agent=my-agent:().id;_.agent-name=my-agent:().company-name;_.user=user:().id;_.user-name=user:().username;_.pnr=gen():6.uppercase();_.id=gen():20;_.counter=_.counter-counters:().len();_.history=_list;_.split-date=today().timestamp();_.spliting-day=todayStart().timestamp();_.splited-by=user:().id;_.splited-by-name=user:().username;_.splited-by-agent=my-agent:().id;_.splited-by-agent-name=my-agent:().company-name];_list:[old-booking:()]:[new-booking:()]._():[_.start-balance-usd=().current-balance;_.booking-details._():[_.seats._():[_.total-seats=_.'passengers-details'.len();_.total-passengers=_.'passengers-details'.len()+_.'passengers-details'.filter():[infants.len()>0].len();_.passengers=_.total-passengers;_.adults=_.'passengers-details'.filter():[age=ADT].len();_.children=_.'passengers-details'.filter():[age=CHD].len();_.infants=_.'passengers-details'.filter():[infants.len()>0].len();_.total-base-fare-usd=_.'passengers-details'.():[base-fare-usd].sum();_.total-taxes-usd=_.'passengers-details'.():[taxes-usd].sum();_.total-fees-usd=_.'passengers-details'.():[fees-usd].sum();_.total-commission-usd=_.'passengers-details'.():[commission-usd].sum();_.total-charge-usd=_.'passengers-details'.clone().():[charge-usd||0].sum();_.total-discount-usd=_.'passengers-details'.clone().():[discount-usd||0].sum();_.total-payable-usd=_.[passengers-details].():[payable-usd].sum();_.'passengers-details'._():[_.start-balance-usd=().current-balance;().current-balance-=[_.payable-usd];_.end-balance-usd=().current-balance;if():[_.infants.len()>0]:[_.infants._():[_.start-balance-usd=().current-balance;().current-balance-=[_.payable-usd];_.end-balance-usd=().current-balance]]]];_.total-seats=_.seats.():[total-seats].sum();_.total-adults=_.seats.():[adults].sum();_.total-children=_.seats.():[children].sum();_.total-infants=_.seats.():[infants].sum();_.total-passengers=_.seats.():[total-passengers].sum();_.total-base-fare-usd=_.seats.():[total-base-fare-usd].sum();_.total-taxes-usd=_.seats.():[total-taxes-usd].sum();_.total-fees-usd=_.seats.():[total-fees-usd].sum();_.total-commission-usd=_.seats.():[total-commission-usd].sum();_.total-discount-usd=_.seats.():[total-discount-usd||0].sum();_.total-charge-usd=_.seats.clone().():[total-charge-usd||0].sum();_.total-payable-usd=_.seats.():[total-payable-usd].sum()];_.total-seats=_.booking-details.0.total-seats;_.total-passengers=_.booking-details.0.total-passengers;_.total-base-fare-usd=_.booking-details.():[total-base-fare-usd].sum();_.total-taxes-usd=_.booking-details.():[total-taxes-usd].sum();_.total-fees-usd=_.booking-details.():[total-fees-usd].sum();_.total-commission-usd=_.booking-details.():[total-commission-usd].sum();_.total-charge-usd=_.booking-details.clone().():[total-charge-usd||0].sum();_.total-discount-usd=_.booking-details.clone().():[total-discount-usd||0].sum();_.total-payable-usd=_.booking-details.():[total-payable-usd].sum();_.end-balance-usd=().current-balance;_.booking-details.0.():[().tickets=_list;seats.():[passengers-details._():[().tickets.push():[_.e-ticket];if():[_.infants.len()>0]:[_.infants._():[().tickets.push():[_.e-ticket]]]]]];_.booking-details.():[().counter=1;seats.():[passengers-details._():[_.counter=().counter;().counter++;if():[_.infants.len()>0]:[_.infants._():[_.counter=().counter;().counter++]]]]];_.counter=().counter-1;if():[_.status=Issued]:[_.tickets=().tickets];updateNames()];booking-data:()=old-booking:().clone();History();old-booking:()=booking-data:().clone();booking-data:()=new-booking:().clone();booking-action:()='New Split '+booking-action:().split(): .1;History();new-booking:()=booking-data:().clone();booking-action:()='Split '+booking-action:().split(): .2",
    "InvoiceRebookBooked": "if():[booking-action:()=Rebook Unconfirmed;!old-booking:().flights.inc():[_.flight-id]]:InvoiceNewBooked()",
    "InvoiceNewBooked": "if():[booking-action:()=New Unconfirmed]:[InvoiceUnconfirmedInc();_.av-seats=[_.av-seats||0]-[__.total-seats];_.unconfirmed-booked-bookings=[_.unconfirmed-issued-bookings||0]+1;_.unconfirmed-booked-seats=[_.unconfirmed-booked-seats||0]+__.total-seats;_.unconfirmed-booked-infants=[_.unconfirmed-booked-infants||0]+__.total-infants;_.unconfirmed-booked-payable-usd=[_.unconfirmed-booked-payable-usd||0]+__.total-payable-usd;_.unconfirmed-booked-commission-usd=[_.unconfirmed-booked-commission-usd||0]+__.total-commission-usd;_.unconfirmed-booked-discount-usd=[_.unconfirmed-booked-discount-usd||0]+[__.total-discount-usd||0];_.unconfirmed-booked-charge-usd=[_.unconfirmed-booked-charge-usd||0]+[__.total-charge-usd||0]]",
    "BookingNewUnconfirmed": "booking-action:()=New Unconfirmed;Flight();Booking();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=booking-data:();success=true;message='Booking created successfuly!']",
    "BookingRebookUnconfirmed": "booking-action:()=Rebook Confirmed;new-booking:()=booking-data:().clone();new-flights:()=my-flights:().clone();new-invoices:()=my-invoices:().clone();booking-data:()=old-booking:().clone();if():[my-agent:().balance-usd+old-booking:().total-payable-usd>=new-booking:().total-payable-usd]:[booking-action:()=Cancel Rebooked;search():[collection=flight;docs=booking-data:().flights]:[my-flights:()=_.data;search():[collection=flight-invoice;field.flight-id.in=booking-data:().flights]:[my-invoices:()=_.data.values();Booking();Flight();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];booking-action:()=Rebook Confirmed;my-flights:()=new-flights:().clone();my-invoices:()=new-invoices:().clone();old-booking:()=booking-data:().clone();booking-data:()=new-booking:().clone();Booking();Flight();Invoice();Agent();User();save():[collection=collection;data=collections:().counter;doc=counter];save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight;data=my-flights:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=_list:[old-booking:()]:[booking-data:()];message='Booking rebooked successfuly!']]]]",
    "getAllAgents": "if():[_.agent;_.user]:[search():[collection=agent;doc=_.agent]:[if():[_.data.admin]:[search():[collection=user;doc=__.user]:[if():[_.data.admin]:[search():[collection=agent;limit=250]:[send():[_.data.values()]]]]]]]",
    "InvoiceConfirmedInc": "_.confirmed-bookings++;_.confirmed-seats+=__.total-seats;_.confirmed-infants+=[__.total-infants||0];_.confirmed-payable-usd+=__.total-payable-usd;_.confirmed-commission-usd+=__.total-commission-usd;_.confirmed-discount-usd+=[__.total-discount-usd||0];_.confirmed-charge-usd+=[__.total-charge-usd||0]",
    "InvoiceUnconfirmedInc": "_.unconfirmed-bookings++;_.unconfirmed-seats+=__.total-seats;_.unconfirmed-infants+=__.total-infants;_.unconfirmed-payable-usd+=__.total-payable-usd;_.unconfirmed-commission-usd+=__.total-commission-usd;_.unconfirmed-discount-usd+=[__.total-discount-usd||0];_.unconfirmed-charge-usd+=[__.total-charge-usd||0]",
    "BookingDisissueConfirmed": "booking-action:()=Disissue Confirmed;old-booking:()=booking-data:().clone();new-booking:()=booking-data:().clone();booking-data:()=old-booking:().clone();booking-action:()=Cancel Disissued;Booking();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];old-booking:()=booking-data:().clone();booking-action:()=Disissue Confirmed;booking-data:()=new-booking:().clone();Booking();Invoice();Agent();User();save():[collection=agent;data=my-agent:()];save():[collection=user;data=user:()];save():[collection=flight-invoice;data=my-invoices:()];save():[collection=flight-booking;data=booking-data:()];send():[data=_list:[old-booking:()]:[booking-data:()];message='Booking disissued successfuly!']",
    "updateNames": "_.names=_list;_.booking-details.0.clone().seats.():[passengers-details._():[if():[_.first-name;_.last-name]:[__.names.push():[_.first-name+ +_.last-name];if():[_.infants.len()>0]:[_.infants._():[if():[_.first-name;_.last-name]:[___.names.push():[_.first-name+ +_.last-name]]]]]]]",
    "InvoiceCancelDisconnectBooked": "if():[booking-action:()=Cancel Disconnect Unconfirmed]:[_.names=_.names.pullItems():[booking-data:().names];InvoiceUnconfirmedDec();_.unconfirmed-disconnected-bookings=[_.unconfirmed-disconnected-bookings||0]+1;_.unconfirmed-disconnected-seats=[_.unconfirmed-disconnected-seats||0]+__.total-seats;_.unconfirmed-disconnected-infants=[_.unconfirmed-disconnected-infants||0]+__.total-infants;_.unconfirmed-disconnected-payable-usd=[_.unconfirmed-disconnected-payable-usd||0]+__.total-payable-usd;_.unconfirmed-disconnected-commission-usd=[_.unconfirmed-disconnected-commission-usd||0]+__.total-commission-usd;_.unconfirmed-disconnected-discount-usd=[_.unconfirmed-disconnected-discount-usd||0]+[__.total-discount-usd||0];_.unconfirmed-disconnected-charge-usd=[_.unconfirmed-disconnected-charge-usd||0]+[__.total-charge-usd||0]]",
    "routeLogin": "if():[!mount]:[if():[!user:()||!agent:()]:[route():login]]",
    "book": "if():[!mounted]:[if():[my-agent:();user:();my-flights:().len()>0;my-invoices:().len()>0]:[if():[booking-action:()=Revive Canceled]:BookingReviveCanceled().elif():[booking-action:()=Cancel Confirmed]:BookingCancelConfirmed().elif():[booking-action:()=Cancel Unconfirmed]:BookingCancelUnconfirmed().elif():[booking-action:()=Connect Confirmed]:BookingConnectConfirmed().elif():[booking-action:()=Disissue Confirmed]:BookingDisissueConfirmed().elif():[booking-action:()=Issue Unconfirmed]:BookingIssueUnconfirmed().elif():[booking-action:()=New Confirmed]:BookingNewConfirmed().elif():[booking-action:()=New Unconfirmed]:BookingNewUnconfirmed().elif():[booking-action:()=Rebook Unconfirmed]:BookingRebookUnconfirmed().elif():[booking-action:()=Reissue Confirmed]:BookingReissueConfirmed().elif():[booking-action:()=Split Confirmed]:BookingSplitConfirmed().elif():[booking-action:()=Split Unconfirmed]:BookingSplitUnconfirmed()]:[if():[!my-agent:()]:[send():[_map.():[msg='Agent is not recognized!';success=false]]].elif():[!user:()]:[send():[_map.():[msg='User is not recognized!';success=false]]].elif():[my-flights:().len()!=booking-data:().flights.len()]:[send():[_map.():[msg='Flights are missing!';success=false]]].elif():[my-invoices:().len()!=booking-data:().flights.len()]:[send():[_map.():[msg='Invoices doesnot exist!';success=false]]]]]"
  }
}